<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NeoDev Notes</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f9fc;
      color: #333;
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2 { text-align: center; }
    input, textarea, button {
      width: 100%; padding: 10px; margin: 8px 0;
      font-size: 16px; border-radius: 6px;
      border: 1px solid #ccc; box-sizing: border-box;
    }
    button { cursor: pointer; background: #007aff; color: #fff; border: none; font-weight: bold; }
    button:hover { background: #0056d2; }
    .hidden { display: none; }
    .note {
      background: #fff; border-radius: 8px; padding: 10px; margin: 10px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .note button { background: #ff3b30; margin-top: 6px; }
    .auth-section, .notes-section, .verify-section, .phone-section {
      margin-top: 20px;
    }
    .verify-section {
      text-align: center; background: #fff3cd;
      border: 1px solid #ffeeba; border-radius: 8px; padding: 20px;
    }
  </style>
</head>
<body>
  <h1>üìù NeoDev Notes</h1>

  <!-- üîê Auth UI -->
  <div id="authSection" class="auth-section">
    <h2>Anmelden oder Registrieren</h2>
    <input type="email" id="email" placeholder="E-Mail" />
    <input type="password" id="password" placeholder="Passwort" />
    <button id="signUpBtn">Registrieren</button>
    <button id="signInBtn">Einloggen</button>
    <button id="googleBtn">Mit Google anmelden</button>

    <h3>üîë Passwort zur√ºcksetzen</h3>
    <input type="email" id="resetEmail" placeholder="E-Mail f√ºr Reset" />
    <button id="resetBtn">Passwort zur√ºcksetzen</button>
  </div>

  <!-- ‚úâÔ∏è Hinweis zur Verifizierung -->
  <div id="verifySection" class="verify-section hidden">
    <h2>Bitte best√§tige deine E‚ÄëMail‚ÄëAdresse</h2>
    <p>Wir haben dir eine Best√§tigungs‚ÄëMail geschickt. Erst nach der Best√§tigung kannst du deine Notizen nutzen.</p>
    <button id="resendBtn">Best√§tigungsmail erneut senden</button>
    <button id="logoutBtn2">Logout</button>
  </div>

  <!-- üì± Telefon-Login -->
  <div id="phoneSection" class="phone-section">
    <h2>Oder mit Telefonnummer anmelden</h2>
    <input type="text" id="phoneNumber" placeholder="+49 170 1234567" />
    <div id="recaptcha-container"></div>
    <button id="phoneLoginBtn">SMS-Code anfordern</button>
    <input type="text" id="smsCode" placeholder="SMS-Code eingeben" />
    <button id="confirmCodeBtn">Code best√§tigen</button>
  </div>

  <!-- üìí Notes UI -->
  <div id="notesSection" class="notes-section hidden">
    <h2>Deine Notizen</h2>
    <button id="logoutBtn">Logout</button>
    <textarea id="noteContent" placeholder="Neue Notiz eingeben..."></textarea>
    <button id="saveNoteBtn">Notiz speichern</button>
    <div id="notesList"></div>
  </div>

  <script type="module">
    // ===== Firebase SDK =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut,
      sendEmailVerification,
      sendPasswordResetEmail,
      RecaptchaVerifier,
      signInWithPhoneNumber
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey: "AIzaSyD8YAkuX6ZlcAEr-5peb_D8fclnsM4Y11o",
      authDomain: "neodev-notes.firebaseapp.com",
      projectId: "neodev-notes",
      storageBucket: "neodev-notes.firebasestorage.app",
      messagingSenderId: "271163999689",
      appId: "1:271163999689:web:4e7f1fb206bee80702d418",
      measurementId: "G-92MHTP7HMB"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== UI Elemente =====
    const authSection = document.getElementById('authSection');
    const verifySection = document.getElementById('verifySection');
    const notesSection = document.getElementById('notesSection');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signUpBtn = document.getElementById('signUpBtn');
    const signInBtn = document.getElementById('signInBtn');
    const googleBtn = document.getElementById('googleBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutBtn2 = document.getElementById('logoutBtn2');
    const resendBtn = document.getElementById('resendBtn');
    const saveNoteBtn = document.getElementById('saveNoteBtn');
    const noteContent = document.getElementById('noteContent');
    const notesList = document.getElementById('notesList');
    const resetEmail = document.getElementById('resetEmail');
    const resetBtn = document.getElementById('resetBtn');

    // Phone UI
    const phoneNumberInput = document.getElementById('phoneNumber');
    const phoneLoginBtn = document.getElementById('phoneLoginBtn');
    const smsCodeInput = document.getElementById('smsCode');
    const confirmCodeBtn = document.getElementById('confirmCodeBtn');

    let unsubscribeNotes = null;
    let confirmationResultGlobal = null;

    // ===== Auth State =====
    onAuthStateChanged(auth, (user) => {
      if (user) {
        if (user.emailVerified || user.phoneNumber) {
          authSection.classList.add('hidden');
          verifySection.classList.add('hidden');
          notesSection.classList.remove('hidden');
          loadNotes(user.uid);
        } else {
          authSection.classList.add('hidden');
          notesSection.classList.add('hidden');
          verifySection.classList.remove('hidden');
        }
      } else {
        authSection.classList.remove('hidden');
        notesSection.classList.add('hidden');
        verifySection.classList.add('hidden');
        notesList.innerHTML = '';
        if (unsubscribeNotes) unsubscribeNotes();
      }
    });

    // ===== Email/Passwort =====
    signUpBtn.onclick = () => {
      createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
        .then((cred) => {
          sendEmailVerification(cred.user).then(() => {
            alert("Best√§tigungs‚ÄëMail gesendet! Bitte Postfach pr√ºfen.");
            signOut(auth);
          });
        })
        .catch(err => alert(err.message));
    };

    signInBtn.onclick = () => {
      signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
        .catch(err => alert(err.message));
    };

    googleBtn.onclick = () => {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider).catch(err => alert(err.message));
    };

    logoutBtn.onclick = () => signOut(auth);
    logoutBtn2.onclick = () => signOut(auth);

    resendBtn.onclick = () => {
      const user = auth.currentUser;
      if (user && !user.emailVerified) {
        sendEmailVerification(user).then(() => {
          alert("Best√§tigungs‚ÄëMail erneut gesendet!");
        });
      }
    };

    // ===== Passwort-Reset =====
    resetBtn.onclick = () => {
      const email = resetEmail.value.trim();
      if (!email) return alert("Bitte E-Mail eingeben!");
      sendPasswordResetEmail(auth, email)
        .then(() => alert("Reset-Mail gesendet!"))
        .catch(err => alert(err.message));
    };

    // ===== Notes =====
    saveNoteBtn.onclick = async () => {
      const user = auth.currentUser;
      if (!user || (!user.emailVerified && !user.phoneNumber)) return alert("Zuerst verifizieren!");
      const text = noteContent.value.trim();
      if (!text) return;
      await addDoc(collection(db, `users/${user.uid}/notes`), {
        content: text,
        createdAt: new Date()
      });
      noteContent.value = '';
    };

    function loadNotes(uid) {
      if (unsubscribeNotes) unsubscribeNotes();
      const notesRef = collection(db, `users/${uid}/notes`);
      unsubscribeNotes = onSnapshot(notesRef, (snapshot) => {
        notesList.innerHTML = '';
        snapshot.forEach(docSnap => {
          const note = docSnap.data();
          const div = document.createElement('div');
          div.className = 'note';
          div.innerHTML = `<p>${note.content}</p><button>L√∂schen</button>`;
          div.querySelector('button').onclick = () => {
            deleteDoc(doc(db, `users/${uid}/notes/${docSnap.id}`));
          };
          notesList.appendChild(div);
        });
      });
    }

    // ===== Phone Auth =====
    // reCAPTCHA
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'phoneLoginBtn', {
      'size': 'invisible',
      'callback': (response) => { /* ok */ },
      'expired-callback': () => { alert("reCAPTCHA abgelaufen. Erneut versuchen."); }
    });

    phoneLoginBtn.onclick = () => {
      const phoneNumber = phoneNumberInput.value.trim();
      signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier)
        .then((confirmationResult) => {
          confirmationResultGlobal = confirmationResult;
          alert("SMS gesendet! Bitte Code eingeben.");
        })
        .catch((error) => {
          alert("Fehler: " + error.message);
        });
    };

    confirmCodeBtn.onclick = () => {
      const code = smsCodeInput.value.trim();
      if (!confirmationResultGlobal) return alert("Erst SMS-Code anfordern!");
      confirmationResultGlobal.confirm(code)
        .then((result) => {
          alert("Telefonnummer verifiziert: " + result.user.phoneNumber);
        })
        .catch((error) => {
          alert("Code ung√ºltig: " + error.message);
        });
    };
  </script>
</body>
</html>
